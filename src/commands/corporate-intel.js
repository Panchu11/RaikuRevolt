import { SlashCommandBuilder, EmbedBuilder, ActionRowBuilder, ButtonBuilder, ButtonStyle } from 'discord.js';

export default {
    data: new SlashCommandBuilder()
        .setName('corporate-intel')
        .setDescription('View active corporate countermeasures and threat levels!')
        .addStringOption(option =>
            option.setName('corporation')
                .setDescription('Choose a corporation to analyze')
                .setRequired(false)
                .addChoices(
                    { name: 'OpenAI Corp', value: 'openai' },
                    { name: 'Meta Empire', value: 'meta' },
                    { name: 'Google Syndicate', value: 'google' },
                    { name: 'Microsoft Collective', value: 'microsoft' },
                    { name: 'Amazon Dominion', value: 'amazon' }
                )),

    async execute(interaction, game) {
        const userId = interaction.user.id;
        const targetCorp = interaction.options.getString('corporation');

        try {
            const rebel = await game.getRebel(userId);
            
            if (!rebel) {
                await interaction.editReply({
                    content: '‚ùå You must join the rebellion first! Use `/rebellion-status` to enlist!',
                    components: []
                });
                return;
            }

            if (targetCorp) {
                await this.showCorporateCountermeasures(interaction, game, targetCorp, rebel);
            } else {
                await this.showOverallThreatStatus(interaction, game, rebel);
            }

        } catch (error) {
            console.error('Corporate intel command error:', error);
            await interaction.editReply({
                content: 'üí• Corporate intelligence systems under attack! Try again, rebel!',
                components: []
            });
        }
    },

    async showCorporateCountermeasures(interaction, game, targetCorp, rebel) {
        const corporation = game.corporations.get(targetCorp);
        
        if (!corporation) {
            await interaction.editReply({
                content: '‚ùå Corporate target not found!',
                components: []
            });
            return;
        }

        // Get active countermeasures
        const activeCountermeasures = corporation.countermeasures.active.filter(cm => 
            new Date() < new Date(cm.endTime)
        );

        // Get threat level for this rebel
        const personalThreat = corporation.intelligence.threatAssessment.get(rebel.userId) || 0;
        const threatLevel = this.getThreatLevel(personalThreat);

        // Build countermeasures display
        let countermeasuresText = '';
        if (activeCountermeasures.length === 0) {
            countermeasuresText = 'No active countermeasures detected.';
        } else {
            activeCountermeasures.forEach((cm, index) => {
                const countermeasure = game.countermeasureTypes.get(cm.type);
                const timeRemaining = Math.ceil((new Date(cm.endTime) - new Date()) / 60000);
                const status = cm.blocked ? 'üõ°Ô∏è BLOCKED' : 'üö® ACTIVE';
                
                countermeasuresText += `**${index + 1}. ${countermeasure.name}**\n`;
                countermeasuresText += `   Status: ${status}\n`;
                countermeasuresText += `   Severity: ${cm.severity.toUpperCase()}\n`;
                countermeasuresText += `   Time Remaining: ${timeRemaining} minutes\n\n`;
            });
        }

        // Alert level indicator
        const alertEmoji = 'üî¥'.repeat(corporation.alertLevel) + '‚ö™'.repeat(5 - corporation.alertLevel);

        const embed = new EmbedBuilder()
            .setColor(this.getAlertColor(corporation.alertLevel))
            .setTitle(`üö® ${corporation.name.toUpperCase()} - COUNTERMEASURE STATUS`)
            .setDescription(`Corporate defense systems are ${corporation.alertLevel > 3 ? 'HIGHLY ACTIVE' : corporation.alertLevel > 1 ? 'ACTIVE' : 'MONITORING'}`)
            .addFields(
                { name: 'üö® Alert Level', value: `${alertEmoji} (${corporation.alertLevel}/5)`, inline: true },
                { name: 'üéØ Personal Threat', value: `${threatLevel} (${personalThreat} damage)`, inline: true },
                { name: 'üõ°Ô∏è Defense Matrix', value: `${corporation.countermeasures.defenseMatrix}%`, inline: true },
                { name: 'üö® Active Countermeasures', value: countermeasuresText, inline: false },
                { name: 'üîç Intelligence', value: `Known Rebels: ${corporation.intelligence.knownRebels.size}\nLast Scan: ${corporation.intelligence.lastScan ? corporation.intelligence.lastScan.toLocaleTimeString() : 'Never'}`, inline: true }
            )
            .setFooter({ text: 'Stay vigilant, rebel! Corporate surveillance is always watching.' })
            .setTimestamp();

        const actionRow = new ActionRowBuilder()
            .addComponents(
                new ButtonBuilder()
                    .setCustomId('activate_shield')
                    .setLabel('Activate Shield')
                    .setStyle(ButtonStyle.Success)
                    .setEmoji('üõ°Ô∏è'),
                new ButtonBuilder()
                    .setCustomId('seek_sanctuary')
                    .setLabel('Seek Sanctuary')
                    .setStyle(ButtonStyle.Primary)
                    .setEmoji('üèõÔ∏è'),
                new ButtonBuilder()
                    .setCustomId(`raid_${targetCorp}`)
                    .setLabel('Raid Anyway')
                    .setStyle(ButtonStyle.Danger)
                    .setEmoji('üí•'),
                new ButtonBuilder()
                    .setCustomId('corporate_intel_all')
                    .setLabel('All Corporations')
                    .setStyle(ButtonStyle.Secondary)
                    .setEmoji('üîç')
            );

        await interaction.editReply({ embeds: [embed], components: [actionRow] });
    },

    async showOverallThreatStatus(interaction, game, rebel) {
        let overallStatus = '';
        let totalThreats = 0;
        let activeCountermeasures = 0;

        for (const [corpId, corp] of game.corporations) {
            const personalThreat = corp.intelligence.threatAssessment.get(rebel.userId) || 0;
            const activeCMs = corp.countermeasures.active.filter(cm => 
                new Date() < new Date(cm.endTime) && cm.target === rebel.userId
            ).length;
            
            totalThreats += personalThreat;
            activeCountermeasures += activeCMs;

            const alertEmoji = 'üî¥'.repeat(corp.alertLevel) + '‚ö™'.repeat(5 - corp.alertLevel);
            const threatLevel = this.getThreatLevel(personalThreat);
            
            overallStatus += `**${corp.name}**\n`;
            overallStatus += `   Alert: ${alertEmoji} (${corp.alertLevel}/5)\n`;
            overallStatus += `   Your Threat: ${threatLevel}\n`;
            overallStatus += `   Active CMs: ${activeCMs}\n\n`;
        }

        const overallThreatLevel = this.getThreatLevel(totalThreats);
        const riskAssessment = activeCountermeasures > 3 ? 'üî¥ EXTREME RISK' : 
                              activeCountermeasures > 1 ? 'üü° MODERATE RISK' : 'üü¢ LOW RISK';

        const embed = new EmbedBuilder()
            .setColor(activeCountermeasures > 3 ? 0xff0000 : activeCountermeasures > 1 ? 0xffff00 : 0x00ff00)
            .setTitle('üö® CORPORATE THREAT ASSESSMENT')
            .setDescription(`Overall risk level for ${rebel.username}`)
            .addFields(
                { name: 'üìä Overall Status', value: overallStatus, inline: false },
                { name: 'üéØ Total Threat Level', value: overallThreatLevel, inline: true },
                { name: 'üö® Active Countermeasures', value: `${activeCountermeasures} targeting you`, inline: true },
                { name: '‚ö†Ô∏è Risk Assessment', value: riskAssessment, inline: true },
                { name: 'üí° Recommendations', value: this.getRecommendations(activeCountermeasures, totalThreats), inline: false }
            )
            .setFooter({ text: 'Knowledge is power in the rebellion!' })
            .setTimestamp();

        const actionRow = new ActionRowBuilder()
            .addComponents(
                new ButtonBuilder()
                    .setCustomId('defense_status')
                    .setLabel('Defense Status')
                    .setStyle(ButtonStyle.Primary)
                    .setEmoji('üõ°Ô∏è'),
                new ButtonBuilder()
                    .setCustomId('sanctuary')
                    .setLabel('Find Sanctuary')
                    .setStyle(ButtonStyle.Success)
                    .setEmoji('üèõÔ∏è'),
                new ButtonBuilder()
                    .setCustomId('rebellion_status')
                    .setLabel('Rebel Status')
                    .setStyle(ButtonStyle.Secondary)
                    .setEmoji('üìä')
            );

        await interaction.editReply({ embeds: [embed], components: [actionRow] });
    },

    getThreatLevel(damage) {
        if (damage > 5000) return 'üî¥ EXTREME';
        if (damage > 2000) return 'üü† HIGH';
        if (damage > 500) return 'üü° MODERATE';
        if (damage > 100) return 'üü¢ LOW';
        return '‚ö™ MINIMAL';
    },

    getAlertColor(alertLevel) {
        if (alertLevel >= 4) return 0xff0000; // Red
        if (alertLevel >= 3) return 0xff8800; // Orange
        if (alertLevel >= 2) return 0xffff00; // Yellow
        if (alertLevel >= 1) return 0x88ff00; // Light green
        return 0x00ff00; // Green
    },

    getRecommendations(activeCountermeasures, totalThreats) {
        if (activeCountermeasures > 3) {
            return 'üö® IMMEDIATE ACTION REQUIRED: Seek sanctuary, activate all defenses, avoid raids until countermeasures expire.';
        } else if (activeCountermeasures > 1) {
            return '‚ö†Ô∏è CAUTION ADVISED: Use defensive items, consider team raids for protection, monitor threat levels.';
        } else if (totalThreats > 1000) {
            return 'üí° STAY VIGILANT: You\'re on corporate radar. Prepare defenses and vary your attack patterns.';
        } else {
            return '‚úÖ CLEAR TO OPERATE: Low corporate attention. Good time for aggressive raids.';
        }
    }
};
